# KeepAlive è·¯ç”±ç¼“å­˜ç»„ä»¶

## ğŸ“– åŠŸèƒ½è¯´æ˜

å®ç°è·¯ç”±çº§åˆ«çš„ç»„ä»¶ç¼“å­˜ï¼ˆç±»ä¼¼ Vue çš„ `<keep-alive>`ï¼‰ï¼Œé¿å…è·¯ç”±åˆ‡æ¢æ—¶ç»„ä»¶è¢«é”€æ¯ï¼Œä¿æŒç»„ä»¶çŠ¶æ€ã€æ»šåŠ¨ä½ç½®ç­‰ã€‚

## ğŸ¯ ä½¿ç”¨åœºæ™¯

- **åˆ—è¡¨é¡µç¼“å­˜**ï¼šä»åˆ—è¡¨è¿›å…¥è¯¦æƒ…åè¿”å›ï¼Œä¿æŒåˆ—è¡¨çš„æœç´¢æ¡ä»¶ã€åˆ†é¡µçŠ¶æ€ã€**æ»šåŠ¨ä½ç½®** â­
- **è¡¨å•é¡µç¼“å­˜**ï¼šå¤šæ­¥éª¤è¡¨å•ï¼Œåœ¨ä¸åŒæ­¥éª¤é—´åˆ‡æ¢æ—¶ä¿æŒå·²å¡«å†™çš„æ•°æ®
- **Tab åˆ‡æ¢**ï¼šå¤šä¸ª Tab é¡µé¢ä¹‹é—´åˆ‡æ¢ï¼Œä¿æŒå„è‡ªçš„çŠ¶æ€

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

- âœ… **ç»„ä»¶çŠ¶æ€ä¿ç•™** - è¡¨å•æ•°æ®ã€ç»„ä»¶å†…éƒ¨çŠ¶æ€å®Œæ•´ä¿ç•™
- âœ… **æ»šåŠ¨ä½ç½®æ¢å¤** - è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤æ¯ä¸ªè·¯ç”±çš„æ»šåŠ¨ä½ç½®ï¼ˆwindow çº§åˆ«ï¼‰
- âœ… **ç”Ÿå‘½å‘¨æœŸç›‘å¬** - æä¾› activated/deactivated ç”Ÿå‘½å‘¨æœŸé’©å­
- âœ… **LRU ç¼“å­˜ç­–ç•¥** - è¶…å‡ºé™åˆ¶æ—¶è‡ªåŠ¨æ¸…ç†æœ€ä¹…æœªè®¿é—®çš„ç¼“å­˜
- âœ… **çµæ´»é…ç½®** - æ”¯æŒç™½åå•ï¼ˆincludeï¼‰å’Œé»‘åå•ï¼ˆexcludeï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®éœ€è¦ç¼“å­˜çš„è·¯ç”±

ç¼–è¾‘ `app/utils/keepAliveConfig.js`ï¼š

```javascript
export const keepAliveInclude = [
  '/settings/user',      // ç”¨æˆ·ç®¡ç†é¡µé¢
  '/settings/role',      // è§’è‰²ç®¡ç†é¡µé¢
  '/antd-demo',          // æ¼”ç¤ºé¡µé¢
];

export const keepAliveExclude = [
  // ä¸éœ€è¦ç¼“å­˜çš„è·¯ç”±ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
];

export const maxCacheCount = 10; // æœ€å¤§ç¼“å­˜æ•°é‡
```

### 2. ç»„ä»¶å·²è‡ªåŠ¨å¯ç”¨

åœ¨ `app/layout/basic.jsx` ä¸­å·²ç»å¯ç”¨äº† KeepAliveï¼š

```jsx
<RouteGuard handle={handle} enableKeepAlive={true} />
```

### 3. ï¼ˆå¯é€‰ï¼‰ç›‘å¬é¡µé¢æ¿€æ´»/å¤±æ´»

åœ¨é¡µé¢ç»„ä»¶ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸ Hooksï¼š

```javascript
import { useKeepAliveEffect, useActivated, useDeactivated } from '@/components/KeepAlive';

function MyPage() {
  // é¡µé¢ä»ç¼“å­˜æ¢å¤æ—¶é‡æ–°è¯·æ±‚æ•°æ®
  useActivated(() => {
    console.log('é¡µé¢ä»ç¼“å­˜æ¢å¤');
    fetchData();
  }, []);

  // é¡µé¢è¢«éšè—åˆ°ç¼“å­˜æ—¶ä¿å­˜çŠ¶æ€
  useDeactivated(() => {
    console.log('é¡µé¢è¢«éšè—');
    saveState();
  }, []);

  return <div>My Page</div>;
}
```

è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ [ç”Ÿå‘½å‘¨æœŸæ–‡æ¡£](./LIFECYCLE_EXAMPLE.md)

### 4. å®Œæˆï¼

ç°åœ¨è®¿é—®é…ç½®çš„è·¯ç”±ï¼Œç»„ä»¶çŠ¶æ€ä¼šè¢«è‡ªåŠ¨ç¼“å­˜ã€‚

## ğŸ”§ é«˜çº§é…ç½®

### è·¯å¾„åŒ¹é…è§„åˆ™

- ä½¿ç”¨ `startsWith` è¿›è¡Œå‰ç¼€åŒ¹é…
- ä¾‹å¦‚ `/settings` ä¼šåŒ¹é… `/settings/user`ã€`/settings/role` ç­‰æ‰€æœ‰å­è·¯ç”±

### åŠ¨æ€è·¯ç”±ç¼“å­˜

å¯¹äºå¸¦å‚æ•°çš„è·¯ç”±ï¼ˆå¦‚ `/user/:id`ï¼‰ï¼Œæ¯ä¸ªä¸åŒçš„å‚æ•°éƒ½ä¼šè¢«ç¼“å­˜ä¸ºç‹¬ç«‹çš„å®ä¾‹ï¼š

```javascript
// ä¼šåˆ†åˆ«ç¼“å­˜
// /user/1
// /user/2
// /user/3
```

### ç¼“å­˜æ•°é‡é™åˆ¶

- é»˜è®¤æœ€å¤šç¼“å­˜ 10 ä¸ªè·¯ç”±ç»„ä»¶
- é‡‡ç”¨ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç­–ç•¥ï¼Œè¶…å‡ºé™åˆ¶æ—¶è‡ªåŠ¨æ¸…é™¤æœ€æ—©è®¿é—®çš„ç¼“å­˜
- å¯åœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´ `maxCacheCount`

## ğŸ“ å·¥ä½œåŸç†

1. **è·¯ç”±ç›‘å¬**ï¼šç›‘å¬ `location.pathname` å˜åŒ–
2. **æ¡ä»¶åˆ¤æ–­**ï¼šæ ¹æ®é…ç½®åˆ¤æ–­å½“å‰è·¯ç”±æ˜¯å¦éœ€è¦ç¼“å­˜
3. **ç»„ä»¶ç¼“å­˜**ï¼šä½¿ç”¨ `Map` å­˜å‚¨è·¯ç”±å¯¹åº”çš„ React å…ƒç´ 
4. **æ»šåŠ¨ä½ç½®ä¿å­˜**ï¼šè·¯ç”±åˆ‡æ¢å‰è‡ªåŠ¨ä¿å­˜å½“å‰é¡µé¢æ»šåŠ¨ä½ç½®
5. **æ˜¾ç¤ºåˆ‡æ¢**ï¼šé€šè¿‡ CSS `display` æ§åˆ¶ç»„ä»¶æ˜¾ç¤º/éšè—
6. **æ»šåŠ¨ä½ç½®æ¢å¤**ï¼šè¿”å›ç¼“å­˜è·¯ç”±æ—¶è‡ªåŠ¨æ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®
7. **LRU ç­–ç•¥**ï¼šè¶…å‡ºç¼“å­˜æ•°é‡é™åˆ¶æ—¶ï¼Œåˆ é™¤æœ€ä¹…æœªè®¿é—®çš„ç¼“å­˜ï¼ˆåŒ…æ‹¬æ»šåŠ¨ä½ç½®ï¼‰

## ğŸ’¡ æ³¨æ„äº‹é¡¹

### âœ… ä¼˜ç‚¹

- ä¿æŒç»„ä»¶çŠ¶æ€ï¼ˆè¡¨å•æ•°æ®ã€æ»šåŠ¨ä½ç½®ç­‰ï¼‰
- é¿å…é‡å¤è¯·æ±‚æ•°æ®
- æå‡ç”¨æˆ·ä½“éªŒ

### âš ï¸ æ³¨æ„

- **å†…å­˜å ç”¨**ï¼šç¼“å­˜çš„ç»„ä»¶ä¼šä¸€ç›´å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸è¦ç¼“å­˜è¿‡å¤šè·¯ç”±
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šç»„ä»¶ä¸ä¼šæ‰§è¡Œå¸è½½ç”Ÿå‘½å‘¨æœŸï¼Œéšè—æ—¶ä»åœ¨ DOM æ ‘ä¸­
- **å‰¯ä½œç”¨æ¸…ç†**ï¼šæ³¨æ„æ¸…ç†å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬ç­‰ï¼Œé¿å…å†…å­˜æ³„æ¼

### ğŸ¯ æœ€ä½³å®è·µ

```jsx
// âœ… æ¨èï¼šåœ¨ç»„ä»¶ä¸­æ­£ç¡®å¤„ç†å‰¯ä½œç”¨
function MyComponent() {
  useEffect(() => {
    const timer = setInterval(() => {
      console.log('tick');
    }, 1000);

    // é‡è¦ï¼šæ¸…ç†å‰¯ä½œç”¨
    return () => clearInterval(timer);
  }, []);

  return <div>My Component</div>;
}
```

## ğŸ” è°ƒè¯•

æŸ¥çœ‹å½“å‰ç¼“å­˜çŠ¶æ€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼š

1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. æ£€æŸ¥ KeepAlive ç»„ä»¶çš„ DOM ç»“æ„
3. æŸ¥çœ‹ `display: none` çš„ div å³ä¸ºè¢«ç¼“å­˜çš„ç»„ä»¶

## ğŸ†š ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| æœ¬æ–¹æ¡ˆï¼ˆdisplay æ§åˆ¶ï¼‰ | ç®€å•ã€æ€§èƒ½å¥½ã€çŠ¶æ€å®Œå…¨ä¿ç•™ | æ‰€æœ‰ç¼“å­˜éƒ½åœ¨ DOM ä¸­ |
| react-activation | åŠŸèƒ½å®Œå–„ã€æ”¯æŒæ›´å¤šç‰¹æ€§ | éœ€è¦é…ç½® babelã€å¢åŠ é¡¹ç›®å¤æ‚åº¦ |
| çŠ¶æ€ç®¡ç†ï¼ˆRedux/Zustandï¼‰ | ç»†ç²’åº¦æ§åˆ¶ | éœ€è¦æ‰‹åŠ¨ç®¡ç†æ‰€æœ‰çŠ¶æ€ |

## ğŸ“– API æ–‡æ¡£

### ç”Ÿå‘½å‘¨æœŸ Hooks

#### useKeepAliveEffect
ç›‘å¬é¡µé¢æ¿€æ´»å’Œå¤±æ´»ã€‚

```javascript
useKeepAliveEffect(
  () => console.log('é¡µé¢æ¿€æ´»'),  // activated
  () => console.log('é¡µé¢å¤±æ´»')   // deactivated
);
```

#### useActivated
ä»…ç›‘å¬é¡µé¢æ¿€æ´»ï¼ˆä»ç¼“å­˜æ¢å¤ï¼‰ã€‚

```javascript
useActivated(() => {
  fetchLatestData();
}, []);
```

#### useDeactivated
ä»…ç›‘å¬é¡µé¢å¤±æ´»ï¼ˆéšè—åˆ°ç¼“å­˜ï¼‰ã€‚

```javascript
useDeactivated(() => {
  saveFormData();
}, [formData]);
```

#### useIsActivated
è·å–å½“å‰é¡µé¢æ¿€æ´»çŠ¶æ€ã€‚

```javascript
const isActive = useIsActivated();
// isActive: true (æ¿€æ´») / false (åœ¨ç¼“å­˜ä¸­)
```

å®Œæ•´ç¤ºä¾‹è¯·è®¿é—®ï¼š`/keepalive-demo` é¡µé¢

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `app/components/KeepAlive/index.jsx` - KeepAlive ç»„ä»¶
- `app/components/KeepAlive/context.jsx` - ç”Ÿå‘½å‘¨æœŸ Context
- `app/components/KeepAlive/LIFECYCLE_EXAMPLE.md` - ç”Ÿå‘½å‘¨æœŸä½¿ç”¨æ–‡æ¡£
- `app/utils/keepAliveConfig.js` - é…ç½®æ–‡ä»¶
- `app/components/RouteGuard/index.jsx` - è·¯ç”±å®ˆå«ï¼ˆé›†æˆ KeepAliveï¼‰
- `app/layout/basic.jsx` - å¸ƒå±€ç»„ä»¶ï¼ˆå¯ç”¨ KeepAliveï¼‰
- `app/pages/keepalive-demo.jsx` - äº¤äº’å¼æ¼”ç¤ºé¡µé¢